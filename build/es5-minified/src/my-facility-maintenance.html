<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/iron-pages/iron-pages.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/paper-input/paper-textarea.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="my-facility-maintenance"><template><style include="shared-styles">:host{display:block;padding:10px;}video{box-sizing:border-box;width:100%;}img{max-width:100%;}section header{display:flex;justify-content:space-between;align-items:center;}section[name="problem"] paper-button{display:block;}div.align-right{display:flex;justify-content:flex-end;}paper-button.green{background-color:var(--paper-green-500);color:white;}paper-input{overflow-x:hidden;}ul.paper-input-suggestions{background:#FFF;box-shadow:0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);cursor:pointer;list-style:none;margin:0;padding:0;position:absolute;z-index:8;}ul.paper-input-suggestions li{padding:5px;}ul.paper-input-suggestions li:hover,
      ul.paper-input-suggestions li[highlighted]{background:#FFF;color:#000;}</style><iron-pages selected="[[stage]]" attr-for-selected="name" fallback-selection="problem"><section name="problem" class="card"><header><div class="circle">1</div><h2>Maintenance Issue Type</h2><div></div></header><iron-ajax auto="" url="https://api.auburnalabama.org/cityworks/servicerequest/problem/" last-response="{{problemCodes}}"></iron-ajax><template is="dom-repeat" items="[[problemCodes]]" filter="_isFacilityMaintenance" sort="_facilityMaintenceOrder"><paper-button tabindex$="[[_addOne(index)]]" on-click="setProblemCode">[[item.Description]]</paper-button></template></section><section name="location" class="card"><header><div class="circle">2</div><h2>[[srType]] — Issue Location</h2><paper-button on-click="goBack">Back</paper-button></header><div><paper-input id="Location" name="Location" label="Facility Name" required=""></paper-input><ul id="PIACList" class="paper-input-suggestions"><template is="dom-repeat" items="[[PIACsearchResults]]"><li>[[item.Name]]</li></template></ul></div><div><paper-input id="Address" name="Address" label="Facility Address" required=""></paper-input></div><div class="align-right"><paper-button id="facilityNext" raised="" class="green" on-click="setLocation">Next</paper-button></div><iron-ajax id="facilitySearch" url="https://api.auburnalabama.org/organization/facility/" last-response="{{PIACsearchResults}}"></iron-ajax><iron-ajax id="facilityLocate" url="https://api.auburnalabama.org/organization/facility/[[position.coords.longitude]]/[[position.coords.latitude]]" on-response="handleClosestFacility"></iron-ajax></section><section name="details" class="card"><header><div class="circle">3</div><h2>[[srType]] — Issue Details</h2><paper-button on-click="goBack">Back</paper-button></header><p><button hidden="[[mediaStreaming]]" on-click="startMedia">Use Camera</button> <button hidden="[[!isMediaReady(mediaStreaming, mediaData)]]" on-click="clearMedia">Clear Photo</button> <button hidden="[[!mediaStreaming]]" on-click="captureMedia">Set Photo</button> <button hidden="[[!mediaStreaming]]" on-click="stopMedia">Cancel</button></p><p><video hidden="[[!mediaStreaming]]" id="videoPreview">Video stream not available.</video><canvas id="videoCapture" hidden=""></canvas><img hidden="[[!isMediaReady(mediaStreaming, mediaData)]]" id="imgCapture"></p><p><paper-textarea id="Details" name="Details" label="Details"></paper-textarea></p><div class="align-right"><paper-button raised="" class="green" on-click="setDetails">Submit</paper-button></div></section><section name="confirmation" class="card"><header><div class="circle">4</div><h2>Success</h2><div></div></header><p>Thank you for submitting your service request. Your Service Request number is #[[serviceRequest.RequestId]].</p><iron-ajax id="srCreate" url="https://api.auburnalabama.org/cityworks/servicerequest" method="POST" content-type="application/json" last-response="{{serviceRequest}}" on-response="srCreated"></iron-ajax><iron-ajax id="srUpload" method="POST"></iron-ajax></section></iron-pages></template><script>var MyFMReport=function(c){function d(){return babelHelpers.classCallCheck(this,d),babelHelpers.possibleConstructorReturn(this,(d.__proto__||Object.getPrototypeOf(d)).apply(this,arguments))}return babelHelpers.inherits(d,c),babelHelpers.createClass(d,[{key:'ready',value:function(){babelHelpers.get(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),'ready',this).call(this),this.user||(window.history.pushState({},null,'/welcome'),window.dispatchEvent(new CustomEvent('location-changed'))),this.addEventListener('keyup',this._goBackListener.bind(this)),this.$.Location.addEventListener('keyup',this._facilityChange.bind(this)),this.$.Location.addEventListener('keydown',this.PIACinputMove.bind(this)),this.$.Location.addEventListener('focusout',this.PIACinputFocus.bind(this)),this.$.PIACList.addEventListener('click',this.PIAClistClick.bind(this)),this.PIACList=this.$.PIACList,this.parseLocation()}},{key:'reset',value:function(){this.stage='',this.serviceRequest={},this.srType=null,this.$.Location.value='',this.$.Address.value='',this.$.Details.value=''}},{key:'_goBackListener',value:function(g){27===g.keyCode&&this.goBack()}},{key:'goBack',value:function(){switch(this.stage){case'location':this.stage='problem';break;case'details':this.stage='location';break;default:this.stage='problem';}}},{key:'goConfirmation',value:function(){this.stage='confirmation'}},{key:'srCreated',value:function(){this.goConfirmation(),this.mediaData&&this.serviceRequest.RequestId&&(this.$.srUpload.url='https://api.auburnalabama.org/cityworks/servicerequest/'+this.serviceRequest.RequestId+'/attachment',this.$.srUpload.body=this.uploadMedia(this.mediaData),this.$.srUpload.generateRequest())}},{key:'PIACinputMove',value:function(g){var h=this.PIACselection||0;switch(g.keyCode){case 13:return void 0===!this.PIACselection||(this.PIACselectResult(this.PIACselection),!1);case 38:this.PIAChighlightResult(0<h?h-1:this.PIACsearchResults.length-1),g.preventDefault();break;case 40:this.PIAChighlightResult(this.PIACselection||this.PIACselection===h?h+1:h);break;default:}return!0}},{key:'PIACinputFocus',value:function(){this._debounce=window.setTimeout(this.PIACclearResult.bind(this),175)}},{key:'PIAClistClick',value:function(g){clearTimeout(this._debounce);for(var h=g.currentTarget,j=0;j<h.children.length;j++)if(h.children[j]===g.srcElement){this.PIACselectResult(j);break}}},{key:'PIACisValidIndex',value:function(g){var h=this.PIACsearchResults;return h&&h.length&&!(h.length<=g)}},{key:'PIAChighlightResult',value:function(g){if(this.PIACisValidIndex(g)){void 0!==this.PIACselection&&this.PIACselection!=g&&this.PIACList.children[this.PIACselection].removeAttribute('highlighted'),this.PIACselection=g||0;var h=this.PIACList.children[g];h.setAttribute('highlighted',!0)}}},{key:'PIACselectResult',value:function(g){this.PIACisValidIndex(g)&&(this._facilityComplete(this.PIACsearchResults[g]),this.dispatchEvent(new CustomEvent('autocomplete-selected',{bubbles:!0,composed:!0})))}},{key:'PIACclearResult',value:function(){this.PIACsearchResults=[],this.PIACselection=void 0}},{key:'_facilityComplete',value:function(g){this.$.Location.value=g.Name,this.$.Address.value=g.Address,this.PIACclearResult(),this.$.facilityNext.focus()}},{key:'_facilityChange',value:function(g){return g.target.value?void(this.$.facilitySearch.params={filter:'startswith(Name, \''+g.target.value+'\') eq true'},this.$.facilitySearch.generateRequest()):this.PIACclearResult()}},{key:'_addOne',value:function(g){return g+1}},{key:'_isFacilityMaintenance',value:function(g){return-1!=g.ProblemCode.indexOf('FM-')&&'FM-GNDMNT'!=g.ProblemCode}},{key:'_facilityMaintenceOrder',value:function(g,h){return'FM-OTH'==g.ProblemCode?1:'FM-OTH'==h.ProblemCode?-1:g.Description<h.Description?-1:1}},{key:'setProblemCode',value:function(g){this.serviceRequest.ProblemSid=g.model.item.ProblemSid,this.srType=g.model.item.Description,this.position&&!this.$.Location.value&&this.$.facilityLocate.generateRequest(),this.stage='location',this.$.Location.focus()}},{key:'setLocation',value:function(){this.$.Location.validate(),this.$.Address.validate(),this.$.Location.invalid||this.$.Address.invalid||(this.serviceRequest.Location=this.$.Location.value,this.serviceRequest.Address=this.$.Address.value,this.stage='details',this.$.Details.focus())}},{key:'setDeviceLocation',value:function(g){this.position=g}},{key:'handleClosestFacility',value:function(g){g.detail.response&&g.detail.response.Name&&(this.$.Location.value=g.detail.response.Name,this.$.Address.value=g.detail.response.Address,this.$.Location.focus(),this.$.Location.inputElement.inputElement.select())}},{key:'setDetails',value:function(){if(this.$.Details.validate(),!this.$.Details.invalid){this.serviceRequest.Details=this.$.Details.value;var g=this.parseName(this.user.name);this.serviceRequest.CallerFirstName=g.first,this.serviceRequest.CallerLastName=g.last,this.serviceRequest.CallerEmail=this.user.email,this.createRequest()}}},{key:'createRequest',value:function(){this.$.srCreate.body=JSON.stringify(this.serviceRequest),this.$.srCreate.generateRequest()}},{key:'parseName',value:function(g){var h=g.split(' ');return h[0].indexOf(',')?{first:h[1],last:h[0].substring(0,h[0].length-1)}:2<h[1].length||!h[2]?{first:h[0],last:h[1]}:{first:h[0],last:h[2]}}},{key:'parseLocation',value:function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(this.setDeviceLocation.bind(this)):x.innerHTML='Geolocation is not supported by this browser.'}},{key:'isMediaReady',value:function(g,h){return!g&&h}},{key:'startMedia',value:function(){navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:!1}).then(function(g){this.mediaStream=g,this.$.videoPreview.srcObject=g,this.$.videoPreview.play()}.bind(this)).catch(function(g){console.error('Video Request error! '+g)}),this.$.videoPreview.addEventListener('canplay',function(){this.mediaStreaming||(this.captureWidth=this.$.videoPreview.videoWidth,this.captureHeight=this.$.videoPreview.videoHeight,this.$.videoCapture.setAttribute('width',this.captureWidth),this.$.videoCapture.setAttribute('height',this.captureHeight),this.mediaStreaming=!0)}.bind(this),!1),this.resetMedia()}},{key:'clearMedia',value:function(){this.stopMedia(),this.mediaData=null,this.$.imgCapture.removeAttribute('src')}},{key:'stopMedia',value:function(){this.$.videoPreview.pause(),this.mediaStreaming=!1,this.mediaStream.getVideoTracks()[0].stop()}},{key:'resetMedia',value:function(){var g=this.$.videoCapture.getContext('2d');g.fillStyle='#AAA',g.fillRect(0,0,this.$.videoCapture.width,this.$.videoCapture.height);var h=this.$.videoCapture.toDataURL('image/png');this.$.imgCapture.setAttribute('src',h)}},{key:'captureMedia',value:function(){var g=this.$.videoCapture.getContext('2d');this.captureWidth&&this.captureHeight?(this.$.videoCapture.width=this.captureWidth,this.$.videoCapture.height=this.captureHeight,g.drawImage(this.$.videoPreview,0,0,this.captureWidth,this.captureHeight),this.mediaData=this.$.videoCapture.toDataURL('image/png'),this.$.imgCapture.setAttribute('src',this.mediaData),this.stopMedia()):this.resetMedia()}},{key:'uploadMedia',value:function(g){var h=this.dataURItoBlob(g),j=new FormData;return j.append('file',h,'capture.png'),j}},{key:'dataURItoBlob',value:function(g){var h=0<=g.split(',')[0].indexOf('base64')?atob(g.split(',')[1]):unescape(g.split(',')[1]);for(var j=g.split(',')[0].split(':')[1].split(';')[0],k=new Uint8Array(h.length),l=0;l<h.length;l++)k[l]=h.charCodeAt(l);return new Blob([k],{type:j})}}],[{key:'is',get:function(){return'my-facility-maintenance'}},{key:'properties',get:function(){return{serviceRequest:{type:Object,value:function(){return{}}},mediaStreaming:{type:Boolean,value:!1},mediaData:{type:String,value:null},stage:String,srType:String,position:Object,user:Object}}}]),d}(Polymer.Element);window.customElements.define(MyFMReport.is,MyFMReport);</script></dom-module></body></html>