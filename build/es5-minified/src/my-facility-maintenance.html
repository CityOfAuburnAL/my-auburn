<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/iron-pages/iron-pages.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/paper-input/paper-textarea.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="my-facility-maintenance"><template><style include="shared-styles">:host{display:block;padding:10px;}video{box-sizing:border-box;width:100%;}img{max-width:100%;}section header{display:flex;justify-content:space-between;align-items:center;}section[name="problem"] paper-button{display:block;}div.align-right{display:flex;justify-content:flex-end;}paper-button.green{background-color:var(--paper-green-500);color:white;}paper-input{overflow-x:hidden;}ul.paper-input-suggestions{background:#FFF;box-shadow:0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);cursor:pointer;list-style:none;margin:0;padding:0;position:absolute;z-index:8;}ul.paper-input-suggestions li{padding:5px;}ul.paper-input-suggestions li:hover,
      ul.paper-input-suggestions li[highlighted]{background:#FFF;color:#000;}</style><iron-pages selected="[[stage]]" attr-for-selected="name" fallback-selection="problem"><section name="problem" class="card"><header><div class="circle">1</div><h2>Maintenance Issue Type</h2><div></div></header><iron-ajax auto="" url="https://api.auburnalabama.org/cityworks/servicerequest/problem/" last-response="{{problemCodes}}"></iron-ajax><template is="dom-repeat" items="[[problemCodes]]" filter="_isFacilityMaintenance" sort="_facilityMaintenceOrder"><paper-button tabindex$="[[_addOne(index)]]" on-click="setProblemCode">[[item.Description]]</paper-button></template></section><section name="location" class="card"><header><div class="circle">2</div><h2>[[srType]] — Issue Location</h2><paper-button on-click="goBack">Back</paper-button></header><div><paper-input id="Location" name="Location" label="Facility Name" required=""></paper-input><ul id="PIACList" class="paper-input-suggestions"><template is="dom-repeat" items="[[PIACsearchResults]]"><li>[[item.Name]]</li></template></ul></div><div><paper-input id="Address" name="Address" label="Facility Address" required=""></paper-input></div><div class="align-right"><paper-button id="facilityNext" raised="" class="green" on-click="setLocation">Next</paper-button></div><iron-ajax id="facilitySearch" url="https://api.auburnalabama.org/organization/facility/" last-response="{{PIACsearchResults}}"></iron-ajax><iron-ajax id="facilityLocate" url="https://api.auburnalabama.org/organization/facility/[[position.coords.longitude]]/[[position.coords.latitude]]" on-response="handleClosestFacility"></iron-ajax></section><section name="details" class="card"><header><div class="circle">3</div><h2>[[srType]] — Issue Details</h2><paper-button on-click="goBack">Back</paper-button></header><p><button hidden="[[mediaStreaming]]" on-click="startMedia">Use Camera</button> <button hidden="[[!isMediaReady(mediaStreaming, mediaData)]]" on-click="clearMedia">Clear Photo</button> <button hidden="[[!mediaStreaming]]" on-click="captureMedia">Set Photo</button> <button hidden="[[!mediaStreaming]]" on-click="stopMedia">Cancel</button></p><p><video hidden="[[!mediaStreaming]]" id="videoPreview">Video stream not available.</video><canvas id="videoCapture" hidden=""></canvas><img hidden="[[!isMediaReady(mediaStreaming, mediaData)]]" id="imgCapture"></p><p><paper-textarea id="Details" name="Details" label="Details"></paper-textarea></p><div class="align-right"><paper-button raised="" class="green" on-click="setDetails">Submit</paper-button></div></section><section name="confirmation" class="card"><header><div class="circle">4</div><h2>Success</h2><div></div></header><p>Thank you for submitting your service request. Your Service Request number is #[[serviceRequest.RequestId]].</p><iron-ajax id="srCreate" url="https://api.auburnalabama.org/cityworks/servicerequest" method="POST" content-type="application/json" last-response="{{serviceRequest}}" on-response="srCreated"></iron-ajax><iron-ajax id="srUpload" method="POST"></iron-ajax></section></iron-pages></template><script>var MyFMReport=function(_Polymer$Element){babelHelpers.inherits(MyFMReport,_Polymer$Element);function MyFMReport(){babelHelpers.classCallCheck(this,MyFMReport);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(MyFMReport).apply(this,arguments))}babelHelpers.createClass(MyFMReport,[{key:"ready",value:function ready(){babelHelpers.get(babelHelpers.getPrototypeOf(MyFMReport.prototype),"ready",this).call(this);if(!this.user){window.history.pushState({},null,"/welcome");window.dispatchEvent(new CustomEvent("location-changed"))}this.addEventListener("keyup",this._goBackListener.bind(this));this.$.Location.addEventListener("keyup",this._facilityChange.bind(this));this.$.Location.addEventListener("keydown",this.PIACinputMove.bind(this));this.$.Location.addEventListener("focusout",this.PIACinputFocus.bind(this));this.$.PIACList.addEventListener("click",this.PIAClistClick.bind(this));this.PIACList=this.$.PIACList;this.parseLocation()}},{key:"reset",value:function reset(){this.stage="";this.serviceRequest={};this.srType=null;this.$.Location.value="";this.$.Address.value="";this.$.Details.value=""}},{key:"_goBackListener",value:function _goBackListener(e){if(27===e.keyCode)this.goBack()}},{key:"goBack",value:function goBack(){switch(this.stage){case"location":this.stage="problem";break;case"details":this.stage="location";break;default:this.stage="problem";break;}}},{key:"goConfirmation",value:function goConfirmation(){this.stage="confirmation"}},{key:"srCreated",value:function srCreated(e){this.goConfirmation();if(this.mediaData&&this.serviceRequest.RequestId){this.$.srUpload.url="https://api.auburnalabama.org/cityworks/servicerequest/".concat(this.serviceRequest.RequestId,"/attachment");this.$.srUpload.body=this.uploadMedia(this.mediaData);this.$.srUpload.generateRequest()}}},{key:"PIACinputMove",value:function PIACinputMove(event){var i=this.PIACselection||0;switch(event.keyCode){case 13:if(!this.PIACselection===void 0)return!0;this.PIACselectResult(this.PIACselection);return!1;case 38:this.PIAChighlightResult(0<i?i-1:this.PIACsearchResults.length-1);event.preventDefault();break;case 40:this.PIAChighlightResult(this.PIACselection||this.PIACselection===i?i+1:i);break;default:break;}return!0}},{key:"PIACinputFocus",value:function PIACinputFocus(){this._debounce=window.setTimeout(this.PIACclearResult.bind(this),175)}},{key:"PIAClistClick",value:function PIAClistClick(event){clearTimeout(this._debounce);for(var parent=event.currentTarget,i=0;i<parent.children.length;i++){if(parent.children[i]===event.srcElement){this.PIACselectResult(i);break}}}},{key:"PIACisValidIndex",value:function PIACisValidIndex(index){var results=this.PIACsearchResults;return!(!results||!results.length||results.length<=index)}},{key:"PIAChighlightResult",value:function PIAChighlightResult(index){if(!this.PIACisValidIndex(index))return;if(this.PIACselection!==void 0&&this.PIACselection!=index){this.PIACList.children[this.PIACselection].removeAttribute("highlighted")}this.PIACselection=index||0;var resultElem=this.PIACList.children[index];resultElem.setAttribute("highlighted",!0)}},{key:"PIACselectResult",value:function PIACselectResult(index){if(!this.PIACisValidIndex(index))return;this._facilityComplete(this.PIACsearchResults[index]);this.dispatchEvent(new CustomEvent("autocomplete-selected",{bubbles:!0,composed:!0}))}},{key:"PIACclearResult",value:function PIACclearResult(){this.PIACsearchResults=[];this.PIACselection=void 0}},{key:"_facilityComplete",value:function _facilityComplete(facility){this.$.Location.value=facility.Name;this.$.Address.value=facility.Address;this.PIACclearResult();this.$.facilityNext.focus()}},{key:"_facilityChange",value:function _facilityChange(e){if(!e.target.value){return this.PIACclearResult()}this.$.facilitySearch.params={filter:"startswith(Name, '".concat(e.target.value,"') eq true")};this.$.facilitySearch.generateRequest()}},{key:"_addOne",value:function _addOne(i){return i+1}},{key:"_isFacilityMaintenance",value:function _isFacilityMaintenance(item){return-1!=item.ProblemCode.indexOf("FM-")&&"FM-GNDMNT"!=item.ProblemCode}},{key:"_facilityMaintenceOrder",value:function _facilityMaintenceOrder(a,b){if("FM-OTH"==a.ProblemCode)return 1;if("FM-OTH"==b.ProblemCode)return-1;return a.Description<b.Description?-1:1}},{key:"setProblemCode",value:function setProblemCode(e){this.serviceRequest.ProblemSid=e.model.item.ProblemSid;this.srType=e.model.item.Description;if(this.position&&!this.$.Location.value)this.$.facilityLocate.generateRequest();this.stage="location";this.$.Location.focus()}},{key:"setLocation",value:function setLocation(){this.$.Location.validate();this.$.Address.validate();if(this.$.Location.invalid||this.$.Address.invalid)return;this.serviceRequest.Location=this.$.Location.value;this.serviceRequest.Address=this.$.Address.value;this.stage="details";this.$.Details.focus()}},{key:"setDeviceLocation",value:function setDeviceLocation(position){this.position=position}},{key:"handleClosestFacility",value:function handleClosestFacility(e){if(e.detail.response&&e.detail.response.Name){this.$.Location.value=e.detail.response.Name;this.$.Address.value=e.detail.response.Address;this.$.Location.focus();this.$.Location.inputElement.inputElement.select()}}},{key:"setDetails",value:function setDetails(){this.$.Details.validate();if(this.$.Details.invalid)return;this.serviceRequest.Details=this.$.Details.value;var callerName=this.parseName(this.user.name);this.serviceRequest.CallerFirstName=callerName.first;this.serviceRequest.CallerLastName=callerName.last;this.serviceRequest.CallerEmail=this.user.email;this.createRequest()}},{key:"createRequest",value:function createRequest(){this.$.srCreate.body=JSON.stringify(this.serviceRequest);this.$.srCreate.generateRequest()}},{key:"parseName",value:function parseName(name){var pieces=name.split(" ");if(pieces[0].indexOf(",")){return{first:pieces[1],last:pieces[0].substring(0,pieces[0].length-1)}}else if(2<pieces[1].length||!pieces[2]){return{first:pieces[0],last:pieces[1]}}return{first:pieces[0],last:pieces[2]}}},{key:"parseLocation",value:function parseLocation(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(this.setDeviceLocation.bind(this))}else{x.innerHTML="Geolocation is not supported by this browser."}}},{key:"isMediaReady",value:function isMediaReady(mediaStreaming,mediaData){return!mediaStreaming&&mediaData}},{key:"startMedia",value:function startMedia(){navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}).then(function(stream){this.mediaStream=stream;this.$.videoPreview.srcObject=stream;this.$.videoPreview.play()}.bind(this)).catch(function(err){console.error("Video Request error! "+err)});this.$.videoPreview.addEventListener("canplay",function(ev){if(!this.mediaStreaming){this.captureWidth=this.$.videoPreview.videoWidth;this.captureHeight=this.$.videoPreview.videoHeight;this.$.videoCapture.setAttribute("width",this.captureWidth);this.$.videoCapture.setAttribute("height",this.captureHeight);this.mediaStreaming=!0}}.bind(this),!1);this.resetMedia()}},{key:"clearMedia",value:function clearMedia(){this.stopMedia();this.mediaData=null;this.$.imgCapture.removeAttribute("src")}},{key:"stopMedia",value:function stopMedia(){this.$.videoPreview.pause();this.mediaStreaming=!1;this.mediaStream.getVideoTracks()[0].stop()}},{key:"resetMedia",value:function resetMedia(){var context=this.$.videoCapture.getContext("2d");context.fillStyle="#AAA";context.fillRect(0,0,this.$.videoCapture.width,this.$.videoCapture.height);var data=this.$.videoCapture.toDataURL("image/png");this.$.imgCapture.setAttribute("src",data)}},{key:"captureMedia",value:function captureMedia(){var context=this.$.videoCapture.getContext("2d");if(this.captureWidth&&this.captureHeight){this.$.videoCapture.width=this.captureWidth;this.$.videoCapture.height=this.captureHeight;context.drawImage(this.$.videoPreview,0,0,this.captureWidth,this.captureHeight);this.mediaData=this.$.videoCapture.toDataURL("image/png");this.$.imgCapture.setAttribute("src",this.mediaData);this.stopMedia()}else{this.resetMedia()}}},{key:"uploadMedia",value:function uploadMedia(imgData){var file=this.dataURItoBlob(imgData),data=new FormData;data.append("file",file,"capture.png");return data}},{key:"dataURItoBlob",value:function dataURItoBlob(dataURI){var byteString;if(0<=dataURI.split(",")[0].indexOf("base64"))byteString=atob(dataURI.split(",")[1]);else byteString=unescape(dataURI.split(",")[1]);for(var mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],ia=new Uint8Array(byteString.length),i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}return new Blob([ia],{type:mimeString})}}],[{key:"is",get:function get(){return"my-facility-maintenance"}},{key:"properties",get:function get(){return{serviceRequest:{type:Object,value:function value(){return{}}},mediaStreaming:{type:Boolean,value:!1},mediaData:{type:String,value:null},stage:String,srType:String,position:Object,user:Object}}}]);return MyFMReport}(Polymer.Element);window.customElements.define(MyFMReport.is,MyFMReport);</script></dom-module></body></html>